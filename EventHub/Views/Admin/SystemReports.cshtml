@model EventHub.Models.ViewModels.SystemReportsViewModel
@{
    ViewData["Title"] = "System Reports";
}

<div class="container-fluid px-4 py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="bi bi-graph-up-arrow me-2"></i>System Reports & Analytics
                    </h1>
                    <p class="text-muted mb-0">Comprehensive overview of your EventHub platform</p>
                </div>
                <div>
                    <a href="@Url.Action("ExportReports", new { format = "csv", startDate = Model.StartDate, endDate = Model.EndDate })"
                       class="btn btn-success">
                        <i class="bi bi-download me-1"></i>Export CSV
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form method="get" asp-action="SystemReports" class="row g-3">
                <div class="col-md-5">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-control" name="startDate"
                           value="@Model.StartDate?.ToString("yyyy-MM-dd")">
                </div>
                <div class="col-md-5">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" name="endDate"
                           value="@Model.EndDate?.ToString("yyyy-MM-dd")">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel me-1"></i>Filter
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Revenue Statistics -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-success bg-opacity-10 rounded p-3">
                                <i class="bi bi-cash-coin text-success fs-1"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Total Revenue</h6>
                            <h2 class="mb-0">Rs. @Model.TotalRevenue.ToString("N2")</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-primary bg-opacity-10 rounded p-3">
                                <i class="bi bi-calendar-month text-primary fs-1"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Revenue This Month</h6>
                            <h2 class="mb-0">Rs. @Model.RevenueThisMonth.ToString("N2")</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-info bg-opacity-10 rounded p-3">
                                <i class="bi bi-calendar-check text-info fs-1"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Revenue This Year</h6>
                            <h2 class="mb-0">Rs. @Model.RevenueThisYear.ToString("N2")</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Statistics -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-people me-2"></i>User Analytics</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-light rounded">
                                <h3 class="mb-0">@Model.TotalUsers</h3>
                                <small class="text-muted">Total Users</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-light rounded">
                                <h3 class="mb-0 text-primary">@Model.TotalCustomers</h3>
                                <small class="text-muted">Customers</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-light rounded">
                                <h3 class="mb-0 text-success">@Model.TotalOrganizers</h3>
                                <small class="text-muted">Organizers</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-light rounded">
                                <h3 class="mb-0 text-danger">@Model.TotalAdmins</h3>
                                <small class="text-muted">Admins</small>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="d-flex justify-content-between">
                                <span>New This Month:</span>
                                <strong>@Model.NewUsersThisMonth</strong>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex justify-content-between">
                                <span>Active Users:</span>
                                <strong class="text-success">@Model.ActiveUsers</strong>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex justify-content-between">
                                <span>Inactive Users:</span>
                                <strong class="text-danger">@Model.InactiveUsers</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Event Statistics -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Event Stats</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Events:</span>
                            <strong>@Model.TotalEvents</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Active:</span>
                            <strong class="text-success">@Model.ActiveEvents</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Inactive:</span>
                            <strong class="text-danger">@Model.InactiveEvents</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Upcoming:</span>
                            <strong class="text-primary">@Model.UpcomingEvents</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Past:</span>
                            <strong class="text-muted">@Model.PastEvents</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Revenue Chart -->
    <div class="row g-4 mb-4">
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Revenue Trend (Last 12 Months)</h5>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Revenue Events & Category Distribution -->
    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>Top 10 Revenue Events</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Event</th>
                                    <th>Organizer</th>
                                    <th>Revenue</th>
                                    <th>Tickets</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var evt in Model.TopRevenueEvents)
                                {
                                    <tr>
                                        <td>@evt.EventTitle</td>
                                        <td>@evt.OrganizerName</td>
                                        <td><strong class="text-success">Rs. @evt.TotalRevenue.ToString("N2")</strong></td>
                                        <td>@evt.TicketsSold</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Events by Category</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Statistics & Recent Bookings -->
    <div class="row g-4 mb-4">
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-ticket-perforated me-2"></i>Booking Stats</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Bookings:</span>
                            <strong>@Model.TotalBookings</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>This Month:</span>
                            <strong>@Model.BookingsThisMonth</strong>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-warning">Pending:</span>
                            <strong>@Model.PendingBookings</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-success">Confirmed:</span>
                            <strong>@Model.ConfirmedBookings</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-primary">Completed:</span>
                            <strong>@Model.CompletedBookings</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-danger">Cancelled:</span>
                            <strong>@Model.CancelledBookings</strong>
                        </div>
                    </div>
                    <canvas id="bookingStatusChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Bookings</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Ref</th>
                                    <th>Customer</th>
                                    <th>Event</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var booking in Model.RecentBookings)
                                {
                                    <tr>
                                        <td><small>@booking.BookingReference</small></td>
                                        <td>@booking.CustomerName</td>
                                        <td>@booking.EventTitle</td>
                                        <td><small>@booking.BookingDate.ToString("MMM dd, yyyy")</small></td>
                                        <td><strong>Rs. @booking.TotalAmount.ToString("N2")</strong></td>
                                        <td>
                                            @switch (booking.Status)
                                            {
                                                case "Pending":
                                                    <span class="badge bg-warning">Pending</span>
                                                    break;
                                                case "Confirmed":
                                                    <span class="badge bg-success">Confirmed</span>
                                                    break;
                                                case "Completed":
                                                    <span class="badge bg-primary">Completed</span>
                                                    break;
                                                case "Cancelled":
                                                    <span class="badge bg-danger">Cancelled</span>
                                                    break;
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Most Popular Events -->
    <div class="row g-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-star me-2"></i>Most Popular Events (By Ticket Sales)</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Rank</th>
                                    <th>Event</th>
                                    <th>Date</th>
                                    <th>Tickets Sold</th>
                                    <th>Total Bookings</th>
                                    <th>Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    int rank = 1;
                                }
                                @foreach (var evt in Model.MostPopularEvents)
                                {
                                    <tr>
                                        <td>
                                            @if (rank <= 3)
                                            {
                                                <span class="badge bg-warning">@rank</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">@rank</span>
                                            }
                                        </td>
                                        <td><strong>@evt.EventTitle</strong></td>
                                        <td>@evt.EventDate.ToString("MMM dd, yyyy")</td>
                                        <td>@evt.TicketsSold tickets</td>
                                        <td>@evt.TotalBookings</td>
                                        <td><strong class="text-success">Rs. @evt.TotalRevenue.ToString("N2")</strong></td>
                                    </tr>
                                    rank++;
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Revenue Trend Chart
        var revenueCtx = document.getElementById('revenueChart').getContext('2d');
        var revenueChart = new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.MonthlyRevenueTrend.Select(m => m.Month + " " + m.Year))),
                datasets: [{
                    label: 'Revenue (Rs.)',
                    data: @Html.Raw(Json.Serialize(Model.MonthlyRevenueTrend.Select(m => m.Revenue))),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'Rs. ' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // Category Distribution Chart
        var categoryCtx = document.getElementById('categoryChart').getContext('2d');
        var categoryChart = new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.EventsByCategory.Select(c => c.Category))),
                datasets: [{
                    label: 'Events',
                    data: @Html.Raw(Json.Serialize(Model.EventsByCategory.Select(c => c.EventCount))),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)',
                        'rgba(201, 203, 207, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });

        // Booking Status Chart
        var bookingStatusCtx = document.getElementById('bookingStatusChart').getContext('2d');
        var bookingStatusChart = new Chart(bookingStatusCtx, {
            type: 'pie',
            data: {
                labels: ['Pending', 'Confirmed', 'Completed', 'Cancelled'],
                datasets: [{
                    data: [
                        @Model.PendingBookings,
                        @Model.ConfirmedBookings,
                        @Model.CompletedBookings,
                        @Model.CancelledBookings
                    ],
                    backgroundColor: [
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(0, 123, 255, 0.8)',
                        'rgba(220, 53, 69, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    </script>
}